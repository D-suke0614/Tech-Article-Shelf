---
description: コードレビューを実施してgit commitを実行
argument-hint: [コミットメッセージのヒント（省略可）]
allowed-tools: Bash(git:*),Bash(npm:*),Read,Task
---

# コミット前レビュー & コミット実行

変更されたファイルをレビューし、問題がなければ適切なコミットメッセージを生成してコミットします。

## 処理フロー

### 1. 変更内容の確認

まず、以下のgitコマンドを**並列実行**してください：

- `git status` - 変更されたファイルを確認
- `git diff --cached` - ステージング済みの変更を確認
- `git diff` - 未ステージングの変更を確認
- `git log -1 --oneline` - 最新のコミットメッセージを確認（メッセージスタイルの参考）

### 2. フォーマットの実行

レビュー前にコードフォーマットを実行してください：

```bash
npm run format
```

フォーマットによってファイルが変更された場合は、その旨をユーザーに通知してください。

### 3. コードレビューの実施

Task toolを使用して `code-reviewer` サブエージェントを呼び出し、包括的なレビューを実施してください。

**レビュー対象**: ステージング済み + 未ステージングの両方のファイル

サブエージェントへの指示例：

```
以下の変更ファイルをレビューしてください：

[変更ファイルリスト]

各ファイルについて、以下の観点で評価してください：
1. セキュリティ（深刻な脆弱性）
2. コードの可読性
3. バグの可能性
4. パフォーマンス
5. テストの網羅性
6. プロジェクト内における一貫性（CLAUDE.md規約準拠）

レビュー結果は指定のフォーマットで返してください。
```

### 4. レビュー結果の判定と表示

**IMPORTANT**: レビュー結果をユーザーに明確に表示してください。

#### レビュー結果の表示

サブエージェントから返されたレビュー結果の以下のセクションを**必ず**ユーザーに表示してください：

- ✅ 承認ステータス（[APPROVED] or [CHANGES_REQUESTED]）
- 📊 サマリー（ファイル数、問題数）
- 🔴 重大な問題（あれば全て表示）
- 🟡 軽微な問題（あれば全て表示）
- ✨ 良い点（あれば表示）
- 💡 推奨事項（あれば全て表示）

#### レビュー結果による判定

レビュー結果が `[CHANGES_REQUESTED]` の場合：

- **コミットを中断**してください
- 重大な問題の詳細を表示してください
- ユーザーに修正後に再度 `/commit` を実行するよう案内してください

レビュー結果が `[APPROVED]` の場合：

- 軽微な問題や推奨事項があれば、それらを明確に表示してください
- 次のステップ（ステージング→コミット）へ進んでください

### 5. ファイルのステージング

未ステージングのファイルがある場合は、`git add .` を実行してすべての変更をステージングしてください。

### 6. コミットメッセージの生成

変更内容とレビュー結果を分析して、以下のルールに従ってコミットメッセージを生成してください：

#### プレフィックスの選択

- **feat**: 新機能の追加（新しいコンポーネント、API、機能など）
- **add**: 既存機能への追加（例: 既存コンポーネントに新しいpropsを追加）
- **fix**: バグ修正
- **refactor**: リファクタリング（機能変更なし）
- **perf**: パフォーマンス改善
- **test**: テストの追加・修正
- **docs**: ドキュメントのみの変更
- **style**: コードフォーマット、セミコロン追加など（機能に影響しない変更）
- **chore**: ビルドプロセス、依存関係の更新など

#### メッセージ本文の作成

- **引数が指定されている場合** ($ARGUMENTS が空でない場合):
  - 引数をヒントとして使用し、適切なプレフィックスと組み合わせてメッセージを生成
  - 例: 引数が「ユーザー登録機能」→ `feat: ユーザー登録機能を実装`

- **引数が指定されていない場合**:
  - 変更内容を分析して、最も適切なメッセージを生成
  - 変更が複数のカテゴリにまたがる場合は、主要な変更を基準にする
  - 簡潔で明確な日本語で記述（1行50文字程度を目安）

#### メッセージフォーマット

```
<プレフィックス>: <変更内容の簡潔な説明>

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### 7. コミットの実行

以下のフォーマットでgit commitを実行してください：

```bash
git commit -m "$(cat <<'EOF'
<生成したコミットメッセージ>

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

### 8. 結果の報告

コミット完了後、以下を表示してください：

- ✅ コミット完了メッセージ
- 📝 生成されたコミットメッセージ
- 📊 変更ファイル数
- 🔍 レビューサマリー（問題数、重大/軽微の内訳）
- 🟡 軽微な問題や推奨事項があれば、その概要を簡潔に表示

## 注意事項

- レビューで重大な問題が見つかった場合は、コミットを実行せず中断してください
- `.env` や `credentials.json` などの機密ファイルが含まれている場合は警告してください
- コミットメッセージは日本語で生成してください
- 必ずHEREDOCを使用してコミットメッセージを渡してください（フォーマットの保持）
